# Error Handling Context

> **Tokens**: ~700 | **Triggers**: error, exception, filter, boundary, correlation, logging

## Overview

Comprehensive error handling with global exception filters, React Error Boundaries, correlation IDs, and user-friendly error UI.

## Key Files

**Backend**:
- `apps/api/src/common/filters/http-exception.filter.ts` - Global filter
- `apps/api/src/common/interfaces/error-response.interface.ts` - Error format
- `apps/api/src/main.ts` - Filter registration

**Frontend**:
- `apps/web/src/components/errors/ErrorBoundary.tsx` - React Error Boundary
- `apps/web/src/components/errors/ErrorFallback.tsx` - Error UI
- `apps/web/src/components/errors/ErrorMessage.tsx` - Inline errors
- `apps/web/src/app/layout.tsx` - ErrorBoundary integration

## Patterns

### Backend Error Response Format

**Interface**:

```typescript
export interface ErrorResponse {
  statusCode: number;
  message: string | string[];
  error?: string;
  timestamp: string;
  path: string;
  correlationId: string;
}
```

### Global Exception Filter

```typescript
import { Catch, ExceptionFilter, ArgumentsHost, HttpException } from '@nestjs/common';
import { v4 as uuidv4 } from 'uuid';

@Catch(HttpException)
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: HttpException, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const response = ctx.getResponse();
    const request = ctx.getRequest();
    const status = exception.getStatus();
    const exceptionResponse = exception.getResponse();

    const correlationId = uuidv4();

    const errorResponse: ErrorResponse = {
      statusCode: status,
      message: typeof exceptionResponse === 'object'
        ? (exceptionResponse as any).message
        : exceptionResponse,
      error: exception.name,
      timestamp: new Date().toISOString(),
      path: request.url,
      correlationId,
    };

    // Log error with correlation ID
    if (status >= 500) {
      console.error(`[${correlationId}]`, exception);
    } else {
      console.warn(`[${correlationId}]`, exception.message);
    }

    response.status(status).json(errorResponse);
  }
}
```

**Registration** (`main.ts`):

```typescript
app.useGlobalFilters(new HttpExceptionFilter());
```

### React Error Boundary

```typescript
'use client';

import React, { Component, ReactNode } from 'react';
import { ErrorFallback } from './ErrorFallback';

interface Props {
  children: ReactNode;
}

interface State {
  hasError: boolean;
  error?: Error;
}

export class ErrorBoundary extends Component<Props, State> {
  constructor(props: Props) {
    super(props);
    this.state = { hasError: false };
  }

  static getDerivedStateFromError(error: Error): State {
    return { hasError: true, error };
  }

  componentDidCatch(error: Error, errorInfo: React.ErrorInfo) {
    console.error('ErrorBoundary caught:', error, errorInfo);
  }

  render() {
    if (this.state.hasError) {
      return <ErrorFallback error={this.state.error} />;
    }

    return this.props.children;
  }
}
```

### Error Message Component

```typescript
interface Props {
  message: string;
  variant?: 'alert' | 'inline' | 'toast';
}

export function ErrorMessage({ message, variant = 'alert' }: Props) {
  return (
    <div className={styles[variant]} role="alert">
      <span className={styles.icon}>⚠️</span>
      <span className={styles.message}>{message}</span>
    </div>
  );
}
```

## Common Operations

### Throwing Custom Errors (Backend)

```typescript
import { NotFoundException, BadRequestException } from '@nestjs/common';

// Not found
if (!user) {
  throw new NotFoundException('User not found');
}

// Bad request
if (invalid) {
  throw new BadRequestException('Invalid input');
}

// Custom validation
if (forbidden) {
  throw new ForbiddenException('You cannot access this resource');
}
```

### Handling Errors (Frontend)

**With Error Boundary**:
```typescript
// In layout.tsx
export default function RootLayout({ children }) {
  return (
    <html>
      <body>
        <ErrorBoundary>
          {children}
        </ErrorBoundary>
      </body>
    </html>
  );
}
```

**With ErrorMessage Component**:
```typescript
function Component() {
  const { error } = useQuery();

  if (error) {
    return <ErrorMessage message="Failed to load data" variant="alert" />;
  }

  return <div>Content</div>;
}
```

### Correlation IDs

**Backend**: Automatically generated by HttpExceptionFilter

**Usage**: Include in logs and client responses

```typescript
console.error(`[${correlationId}] Error details:`, error);
```

**Frontend**: Display or log for debugging

```typescript
if (error.correlationId) {
  console.log(`Error ID: ${error.correlationId}`);
}
```

## Gotchas

### Environment-Aware Error Details

**Development**: Show stack traces for debugging

```typescript
const errorResponse = {
  ...basicError,
  stack: process.env.NODE_ENV === 'development' ? exception.stack : undefined,
};
```

**Production**: Hide sensitive details

```typescript
message: status >= 500 ? 'Internal server error' : exception.message,
```

### Class Component for Error Boundary

**Problem**: React Error Boundaries must be class components

**Solution**: Use class component pattern (shown above)

**Note**: Hooks (useState, useEffect) cannot be used in Error Boundaries

### UUID ESM Import

**Problem**: Jest cannot handle uuid ESM exports by default

**Solution**: Add to Jest transformIgnorePatterns

```typescript
// jest.config.ts
transformIgnorePatterns: [
  'node_modules/(?!(uuid)/)',
],
```

## Quick Commands

```bash
# Run E2E tests with error handling validation
npx nx e2e api-e2e --testPathPattern=security

# Check all tests
npm run health-check
```

## Test Coverage

- Global exception filter: ✅ Covered in security E2E
- Correlation ID format: ✅ Validated (UUID format)
- Error Boundary: ✅ Covered in component tests
- ErrorMessage variants: ✅ Covered in component tests

## Architecture Decisions

**ADR-016**: Comprehensive Error Handling Strategy

See [memory/decisions/](../decisions/) for full ADRs.

## Related

- [API Module](api.md) - Exception handling in controllers
- [Frontend Module](frontend.md) - React Error Boundary pattern
- [Security Module](security.md) - Error responses with security headers
- [Testing Module](testing.md) - Error handling E2E tests
